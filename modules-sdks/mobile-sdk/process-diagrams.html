<!DOCTYPE html>
<html lang="en-US">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta name="mobile-web-app-capable" content="yes">
        <meta name="theme-color" content="#000">
        <meta name="application-name" content="Process Diagrams">
        <meta name="msapplication-TileColor" content="#000">
        <meta name="msapplication-TileImage" content="https://design.swedbankpay.com/v/4.6.1/icons/mstile-144x144.png">
        <meta property="og:type" value="website" />
        <meta property="og:url" value="https://developer.swedbankpay.com/modules-sdks/mobile-sdk/process-diagrams.html" />
        <meta property="og:title" value="Process Diagrams" />
        <meta name="title" content="Process Diagrams" />
        <meta property="og:description" value="Swedbank Pay Developer Portal" />
        <meta name="description" content="Swedbank Pay Developer Portal" />
        <meta property="og:image" value="/assets/img/swedbank-pay-developer-portal.png" />
        <title>Process Diagrams</title>
        <link rel="stylesheet" href="https://design.swedbankpay.com/v/4.6.1/styles/dg-style.css" />
        <link rel="stylesheet" href="/assets/css/swedbank-pay-design-guide-theme.css" />
        <link rel="stylesheet" href="/assets/css/pygments-autumn.css" />
        <link rel="shortcut icon" href="https://design.swedbankpay.com/v/4.6.1/icons/favicon.ico">
        <link rel="icon" type="image/png" sizes="16x16" href="https://design.swedbankpay.com/v/4.6.1/icons/favicon-16x16.png">
        <link rel="icon" type="image/png" sizes="32x32" href="https://design.swedbankpay.com/v/4.6.1/icons/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="228x228" href="https://design.swedbankpay.com/v/4.6.1/icons/coast-228x228.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Process Diagrams">
<link rel="apple-touch-icon" sizes="57x57" href="https://design.swedbankpay.com/v/4.6.1/icons/apple-touch-icon-57x57.png">
<link rel="apple-touch-icon" sizes="60x60" href="https://design.swedbankpay.com/v/4.6.1/icons/apple-touch-icon-60x60.png">
<link rel="apple-touch-icon" sizes="72x72" href="https://design.swedbankpay.com/v/4.6.1/icons/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="76x76" href="https://design.swedbankpay.com/v/4.6.1/icons/apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" sizes="114x114" href="https://design.swedbankpay.com/v/4.6.1/icons/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="120x120" href="https://design.swedbankpay.com/v/4.6.1/icons/apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" sizes="144x144" href="https://design.swedbankpay.com/v/4.6.1/icons/apple-touch-icon-144x144.png">
<link rel="apple-touch-icon" sizes="152x152" href="https://design.swedbankpay.com/v/4.6.1/icons/apple-touch-icon-152x152.png">
<link rel="apple-touch-icon" sizes="167x167" href="https://design.swedbankpay.com/v/4.6.1/icons/apple-touch-icon-167x167.png">
<link rel="apple-touch-icon" sizes="180x180" href="https://design.swedbankpay.com/v/4.6.1/icons/apple-touch-icon-180x180.png">
<link rel="apple-touch-icon" sizes="1024x1024" href="https://design.swedbankpay.com/v/4.6.1/icons/apple-touch-icon-1024x1024.png">
<link rel="apple-touch-startup-image"
    media="(device-width: 320px) and (device-height: 480px) and (orientation: ) and (-webkit-device-pixel-ratio: 1)"
    href="https://design.swedbankpay.com/v/4.6.1/icons/apple-touch-startup-image-320x460.png">
<link rel="apple-touch-startup-image"
    media="(device-width: 320px) and (device-height: 480px) and (orientation: ) and (-webkit-device-pixel-ratio: 2)"
    href="https://design.swedbankpay.com/v/4.6.1/icons/apple-touch-startup-image-640x920.png">
<link rel="apple-touch-startup-image"
    media="(device-width: 320px) and (device-height: 568px) and (orientation: ) and (-webkit-device-pixel-ratio: 2)"
    href="https://design.swedbankpay.com/v/4.6.1/icons/apple-touch-startup-image-640x1096.png">
<link rel="apple-touch-startup-image"
    media="(device-width: 375px) and (device-height: 667px) and (orientation: ) and (-webkit-device-pixel-ratio: 2)"
    href="https://design.swedbankpay.com/v/4.6.1/icons/apple-touch-startup-image-750x1294.png">
<link rel="apple-touch-startup-image"
    media="(device-width: 414px) and (device-height: 736px) and (orientation: landscape) and (-webkit-device-pixel-ratio: 3)"
    href="https://design.swedbankpay.com/v/4.6.1/icons/apple-touch-startup-image-1182x2208.png">
<link rel="apple-touch-startup-image"
    media="(device-width: 414px) and (device-height: 736px) and (orientation: portrait) and (-webkit-device-pixel-ratio: 3)"
    href="https://design.swedbankpay.com/v/4.6.1/icons/apple-touch-startup-image-1242x2148.png">
<link rel="apple-touch-startup-image"
    media="(device-width: 768px) and (device-height: 1024px) and (orientation: landscape) and (-webkit-device-pixel-ratio: 1)"
    href="https://design.swedbankpay.com/v/4.6.1/icons/apple-touch-startup-image-748x1024.png">
<link rel="apple-touch-startup-image"
    media="(device-width: 768px) and (device-height: 1024px) and (orientation: portrait) and (-webkit-device-pixel-ratio: 1)"
    href="https://design.swedbankpay.com/v/4.6.1/icons/apple-touch-startup-image-768x1004.png">
<link rel="apple-touch-startup-image"
    media="(device-width: 768px) and (device-height: 1024px) and (orientation: landscape) and (-webkit-device-pixel-ratio: 2)"
    href="https://design.swedbankpay.com/v/4.6.1/icons/apple-touch-startup-image-1496x2048.png">
<link rel="apple-touch-startup-image"
    media="(device-width: 768px) and (device-height: 1024px) and (orientation: portrait) and (-webkit-device-pixel-ratio: 2)"
    href="https://design.swedbankpay.com/v/4.6.1/icons/apple-touch-startup-image-1536x2008.png">
<script src="/assets/js/mermaid.min.js"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
        <script src="/assets/tipuesearch/tipuesearch_content.js"></script>
        <script src="/assets/tipuesearch/tipuesearch_set.js"></script>
        <script src="/assets/tipuesearch/tipuesearch.min.js"></script>
        <link href="https://fonts.googleapis.com/css?family=Material+Icons+Outlined" rel="stylesheet">
    </head>

    <body>
        <div id="designguide">
            <header class="topbar topbar-md-wide designguide-header">
                <button type="button" class="topbar-btn"><i class="material-icons topbar-btn-icon">menu</i></button>
                <a href="https://developer.swedbankpay.com" class="topbar-logo"><img
                        src="https://design.swedbankpay.com/v/4.6.1/img/swedbankpay-logo.svg" alt="logo"></a>
                <nav class="topbar-nav">
                    <div class="topbar-link-container">
                        <button type="button" class="topbar-close"><i class="material-icons">close</i></button>

                        
                        

                        

                        <a 
                            href="/"><span>Home</span></a>

                        
                        
                        <a 
                            href="/checkout/"><span>Checkout</span></a>
                        
                        
                        <a 
                            href="/payments/"><span>Payments</span></a>
                        
                        
                        <a 
                            href="/gift-cards/"><span>Gift Cards</span></a>
                        
                        
                        <a 
                            href="/resources/"><span>Resources</span></a>
                        

                        <div class="topbar-info topbar-link-right">
                            <div class="topbar-info-contact">
                                <a href="https://github.com/SwedbankPay/developer.swedbankpay.com/tree/develop/modules-sdks/mobile-sdk/process-diagrams.md" target="_blank"
                                    rel="noopener noreferrer" title="Edit this page on GitHub">
                                    <svg aria-labelledby="simpleicons-github-icon" role="img" viewBox="0 0 24 24"
                                        xmlns="http://www.w3.org/2000/svg">
                                        <title id="simpleicons-github-icon">Edit this page on GitHub</title>
                                        <path
                                            d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12" />
                                    </svg>
                                </a>
                            </div>
                        </div>
                    </div>
                </nav>
            </header>

            <div class="documentation">
                <div class="row">
                    <div class="col-xxl-2 col-md-3">
                        <div class="doc-sidebar">
                            
                            <form class="doc-search" action="/search">
                                <input type="text" class="form-control" name="q" id="tipue_search_input"
                                    placeholder="Search..." autocomplete="off" pattern=".{3,}"
                                    title="At least 3 characters">
                            </form>
                            
                            
                            <nav class="documentation-nav">
                                
                                
                                <div class="nav-group active">
                                    <div class="nav-heading">
                                        <i class="material-icons">keyboard_arrow_right</i>
                                        <span>Mobile SDK</span>
                                    </div>

                                    
                                    <ul>
                                        
                                        
                                        <li><a  href="/modules-sdks/mobile-sdk/"><span>Introduction</span></a></li>
                                        
                                        
                                        <li><a  href="/modules-sdks/mobile-sdk/merchant-backend"><span>Merchant Backend</span></a></li>
                                        
                                        
                                        <li><a  href="/modules-sdks/mobile-sdk/merchant-backend-sample-code"><span>Merchant Backend Sample Code</span></a></li>
                                        
                                        
                                        <li><a  href="/modules-sdks/mobile-sdk/android"><span>Android</span></a></li>
                                        
                                        
                                        <li><a  href="/modules-sdks/mobile-sdk/ios"><span>iOS</span></a></li>
                                        
                                        
                                        <li><a  aria-current="page" class="active"
                                                 href="/modules-sdks/mobile-sdk/process-diagrams"><span>Process Diagrams</span></a></li>
                                        
                                        
                                        <li><a  href="/modules-sdks/mobile-sdk/plain-webview"><span>Plain Webview</span></a></li>
                                        
                                    </ul>
                                    
                                </div>
                                
                            </nav>
                            
                        </div>
                    </div>

                    <main class="doc-view col-xxl-10 col-md-9">
                        <div class="doc-container">
                            <h1>Process Diagrams</h1>
                            <div class="row">
                                <div class="doc-body col-lg-10">
                                    
                                    <div class="alert alert-complex alert-warning"><header class="alert-header">
            
                <i class="material-icons alert-icon">warning</i>
      <h3>
        
        
          Unsupported
        
        
      </header>
    

    
        
            <div class="alert-body">
                <p>The SDK is at an early stage of development
and is not supported as of yet by Swedbank Pay. It is provided as a
convenience to speed up your development, so please feel free to play around.
However, if you need support, please wait for a future, stable release.</p>
            </div>
        
    
</div>

<div class="jumbotron">
    <p>The previous pages have dealt with each component. This page contains flowcharts that illustrate the entire process, taking into account all the components involved.</p>

<p>It is recommended to read through the earlier pages first. This page can them help you keep a picture of the whole system in mind, and serve as a quick reference to the different steps and components.</p>

</div>
    
      <h2 id="initialization">
        
        
          Initialization <a href="#initialization" class="header-anchor"></a>
        
        
      </h2>

<p>To use the SDK, you must have a valid <code class="language-html highlighter-rouge">Configuration</code> for it. The API for this is a bit different in Android and iOS, but generally you will only need one <code class="language-html highlighter-rouge">Configuration</code> for your app. On Android set it to <code class="language-html highlighter-rouge">PaymentFragment.defaultConfiguration</code>; on iOS store it in a convenient variable.</p>

<pre><code class="language-mermaid">sequenceDiagram
    alt Android
        App -&gt;&gt; SDK: Configuration.Builder(backendUrl)...build()
        SDK --&gt;&gt; App: configuration
        App -&gt;&gt; SDK: PaymentFragment.defaultConfiguration = configuration
    else iOS
        App -&gt;&gt; SDK: SwedbankPaySDK.Configuration.init(backendUrl: backendUrl)
        SDK --&gt;&gt; App: configuration
    end
</code></pre>

<p>When you want to make a payment, you construct a <code class="language-html highlighter-rouge">PaymentOrder</code> with the correct content. A very important part of the <code class="language-html highlighter-rouge">PaymentOrder</code> is the <code class="language-html highlighter-rouge">urls</code> field. The SDK has convenience methods for creating one; unless your use-case is advanced, you should use these. On Android use the <code class="language-html highlighter-rouge">PaymentOrderUrls(context, backendUrl, [callbackUrl], [termsOfServiceUrl])</code> constructor; on iOS use the <code class="language-html highlighter-rouge">PaymentOrderUrls.init(configuration:language:[callbackUrl:][termsOfServiceUrl:])</code> initializer. In both cases the convenience method depends on your <code class="language-html highlighter-rouge">Configuration</code> (<code class="language-html highlighter-rouge">backendUrl</code>is part of the <code class="language-html highlighter-rouge">Configuration</code>), so be careful if you have multiple Configurations in your app.</p>

<p>Additionally, you may construct a <code class="language-html highlighter-rouge">Consumer</code> if you wish to identify the payer. This enables saving payment details for further payments.</p>

<pre><code class="language-mermaid">sequenceDiagram
    participant User
    participant App
    participant SDK

    User -&gt;&gt; App : Begin payment
    rect rgba(138, 205, 195, 0.1)
        note right of App: Build Payment Order
        alt Android
            App -&gt;&gt; SDK: PaymentOrder(...) or PaymentOrder.Builder()...build()
            SDK --&gt;&gt; App: paymentOrder
        else iOS
            App -&gt;&gt; SDK: SwedbankPaySDK.PaymentOrder.init(...)
            SDK --&gt;&gt; App: paymentOrder
        end
    end
    opt Build Consumer
        alt Android
            App -&gt;&gt; SDK: Consumer(...)
            SDK --&gt;&gt; App: consumer
        else iOS
            App -&gt;&gt; SDK: Consumer.init(...)
            SDK --&gt;&gt; App: consumer
        end
    end
    rect rgba(138, 205, 195, 0.1)
        note right of App: Create and configure payment UI component
        alt Android
            App -&gt;&gt; SDK: PaymentFragment.ArgumentsBuilder()...build()
            SDK --&gt;&gt; App: arguments
            App -&gt;&gt; SDK: PaymentFragment()
            SDK --&gt;&gt; App: paymentFragment
            App -&gt;&gt; SDK: paymentFragment.arguments = arguments
            App -&gt;&gt; SDK: activity.paymentViewModel.[rich]state.observe(...)
        else iOS
            App -&gt;&gt; SDK: SwedbankPaySDKController.init(...)
            SDK --&gt;&gt; App: swedbankPaySDKController
            App -&gt;&gt; SDK: swedbankPaySDKController.delegate = ...
        end
    end
    App -&gt;&gt; App : Show payment UI component
</code></pre>
    
      <h2 id="discover-endpoints">
        
        
          Discover Endpoints <a href="#discover-endpoints" class="header-anchor"></a>
        
        
      </h2>

<p>The Merchant Backend is specified with a single static entry point; other interfaces are accessed by following links from previous responses. A request to the static entry point currently returns links to the <code class="language-html highlighter-rouge">consumers</code> and <code class="language-html highlighter-rouge">paymentorders</code> endpoints. In most cases the response to this request can be cached, and thus only needs to be made once per App session.</p>

<pre><code class="language-mermaid">sequenceDiagram
    participant SDK
    participant Merchant

    SDK -&gt;&gt; Merchant: GET /
    Merchant --&gt;&gt; SDK: { "consumers": "[consumers]", "paymentorders": "[paymentorders]" }
</code></pre>
    
      <h2 id="optional-checkin">
        
        
          Optional Checkin <a href="#optional-checkin" class="header-anchor"></a>
        
        
      </h2>

<p>If <code class="language-html highlighter-rouge">Consumer</code> was provided, the payment beings with a “checkin” flow, where the payer is identified. This allows for saving payment details for later payments.</p>

<p>The checkin flow is simple: first a request is made to begin a checkin session, then an html page is constructed using the script link received from that request, and when that page successfully identifies the payer, a javascript callback is received. The <code class="language-html highlighter-rouge">consumerProfileRef</code> received from that callback is then set to the Payment Order to be processed.</p>

<pre><code class="language-mermaid">sequenceDiagram
    participant SDK
    participant Merchant
    participant SwedbankPay as Swedbank Pay
    participant WebView
    participant User

    SDK -&gt;&gt; Merchant: POST [consumers] { "operation": "initiate-consumer-session", ... }
    Merchant -&gt;&gt; SwedbankPay: POST /psp/consumers/ { "operation": "initiate-consumer-session", ... }
    SwedbankPay --&gt;&gt; Merchant: { "operations": [{ "rel": "view-consumer-identification", "href": "[consumer-script]" }] }
    Merchant --&gt;&gt; SDK: { "operations": [{ "rel": "view-consumer-identification", "href": "[consumer-script]" }] }
    SDK -&gt;&gt; WebView: &lt;html&gt;...&lt;script src="[consumer-script]"&gt;...payex.hostedView.consumer(...)...&lt;/html&gt;
    WebView -&gt;&gt; User: Show checkin UI
    User -&gt;&gt; WebView: Enter personal details
    WebView -&gt;&gt; SDK: onConsumerIdentified({ "consumerProfileRef" : "..." })
    SDK -&gt;&gt; SDK: paymentOrder.payer = { "consumerProfileRef" : "..." }
</code></pre>
    
      <h2 id="begin-checkout">
        
        
          Begin Checkout <a href="#begin-checkout" class="header-anchor"></a>
        
        
      </h2>

<p>With the Payment Order ready, the SDK begins the “checkout” flow, where the actual payment is made. The checkout flow begins similarly to the checkin flow: a request is made to create a Payment Order, then an html page is constructed and displayed to the user. In the case of the “create Payment Order” request, however, it is expected that the Merchant Backend processes
the request and response: Setting of <code class="language-html highlighter-rouge">payeeId</code> and <code class="language-html highlighter-rouge">paymentReference</code> in particular seems better left to the backend; similarly the backend is probably interested in storing the <code class="language-html highlighter-rouge">id</code> of the created Payment Order for capture and other possible operations.</p>

<p>At this point the user is interacting with the payment menu; the next step depends on the exact payment method chosen.</p>

<pre><code class="language-mermaid">sequenceDiagram
    participant SDK
    participant Merchant
    participant SwedbankPay as Swedbank Pay
    participant WebView
    participant User

    SDK -&gt;&gt; Merchant: POST [paymentorders] { paymentorder: {...} }
    Merchant -&gt;&gt; Merchant: Preprocess payment order (e.g. create payeeReference)
    Merchant -&gt;&gt; SwedbankPay: POST /psp/paymentorders/ { paymentorder: {...} }
    SwedbankPay --&gt;&gt; Merchant: { "id": "...", "operations": [{ "rel": "view-paymentorder", "href": "[paymentorder-script]" }], ... }
    Merchant -&gt;&gt; Merchant: Postprocess payment order (e.g. store id)
    Merchant --&gt;&gt; SDK: { "id": "...", "operations": [{ "rel": "view-paymentorder", "href": "[paymentorder-script]" }], ... }
    SDK -&gt;&gt; WebView: &lt;html&gt;...&lt;script src="[paymentorder-script]"&gt;...payex.hostedView.paymentMenu(...)...&lt;/html&gt;
    WebView -&gt;&gt; User: Show checkout UI
    User -&gt;&gt; WebView: Choose payment method and enter details
</code></pre>
    
      <h2 id="external-content">
        
        
          External Content <a href="#external-content" class="header-anchor"></a>
        
        
      </h2>

<p>While some payments may be completed inside the payment menu in their entirety, others will require interaction with some external web page, and/or application. In most cases external web pages can be opened in the same web view used to show the payment menu, and when they want to return to the payment menu, they signal this by attempting to navigate to the url set as <code class="language-html highlighter-rouge">paymentUrl</code> in the Payment Order. We intercept this navigation, and reload the payment menu, as appropriate.</p>

<p>When an external application is launched, the flow signals the return to the payment menu by again opening <code class="language-html highlighter-rouge">paymentUrl</code>. This time, however, we cannot intercept it. The system then handles opening that url the usual way. For maximum compatibility, <code class="language-html highlighter-rouge">paymentUrl</code> is a regular https url. On iOS, <code class="language-html highlighter-rouge">paymentUrl</code> is designed to be in format that is registered as a <a href="https://developer.apple.com/documentation/uikit/inter-process_communication/allowing_apps_and_websites_to_link_to_your_content">Universal Link</a> to the app, which causes the system to open <code class="language-html highlighter-rouge">paymentUrl</code> in the app. The example backend serves a <code class="language-html highlighter-rouge">/.well-known/apple-app-site-association</code> file that assigns the paths under <code class="language-html highlighter-rouge">/sdk-callback/</code> to be Universal Links to the application set in the configuration. The SDK defaults to building <code class="language-html highlighter-rouge">paymentUrl</code> under this path. Combined with the proper configuration in the app and backend, this makes <code class="language-html highlighter-rouge">paymentUrl</code>s be Universal Links. On Android 6.0 and later it is possible to do a similar thing, but it is much more difficult to set up on the server side, and we need a solution for earlier versions anyway. Therefore, on Android, <code class="language-html highlighter-rouge">paymentUrl</code> will be opened in the browser.</p>

<p>Finally, in our testing, we have seen that certain external pages used with certain payment instruments do not work correctly inside a web view, and must be shown in the browser instead. If we determine that the external page is one of these pages, it is opened in the browser. Again, return to the payment menu is signaled by a navigation to <code class="language-html highlighter-rouge">paymentUrl</code>, which will, in this case be opened in the browser on both platforms (but see below for iOS details).</p>

<pre><code class="language-mermaid">sequenceDiagram
    participant App
    participant SDK
    participant WebView
    participant System
    participant Browser
    participant Ext as External App
    participant User

    WebView -&gt;&gt; SDK: Navigate to another page
    alt Navigation is to a regular http(s) URL
        SDK -&gt;&gt; SDK: Check web view compatibility
        alt Compatible with Web Wiew
            SDK -&gt;&gt; WebView: Proceed with navigation normally ①
            WebView -&gt;&gt; SDK: Navigate to paymentUrl ②
            SDK -&gt;&gt; SDK: Recognize paymentUrl
            SDK -&gt;&gt; WebView: Cancel navigation
        else Not Compatible with Web Wiew
            SDK -&gt;&gt; WebView: Cancel navigation
            SDK -&gt;&gt; System: Open URL
            System -&gt;&gt; Browser: Open URL in Browser
            User -&gt;&gt; Browser: Handle external flow
            Browser -&gt;&gt; User: Handle external flow
            Browser -&gt; Browser: Open paymentUrl in Browser
        end
    else Navigation is to an app-specific URL (custom scheme, Android Deep Link/App Link, iOS Universal Link)
        SDK -&gt;&gt; WebView: Cancel navigation
        SDK -&gt;&gt; System: Open URL
        System -&gt;&gt; Ext: Launch URL-appropriate app
        User -&gt;&gt; Ext: Handle external flow
        Ext -&gt;&gt; User: Handle external flow
        Ext -&gt;&gt; System: Open paymentUrl
        alt Android
            System -&gt;&gt; Browser: Open paymentUrl in Browser ③
        else iOS
            System -&gt;&gt; App: Launch app with paymentUrl ④
        end
    end
</code></pre>

<ul>
  <li>① The same check is repeated for any further navigation inside the WebView</li>
  <li>② All properly configured authentication flows must end up here</li>
  <li>③ On Android, paymentUrl is an https URL that redirects to an Android Intent URL.</li>
  <li>④ On iOS, paymentUrl is a Universal Link. When an app open a Universal Link to\nanother app, it should be routed to that app instead of the Browser. However, Univeral Links are finicky things, and it is not impossible that it gets opened in the Browser instead. In that case, the flow continues with “paymentUrl opened in Browser” below instead.</li>
</ul>
    
      <h3 id="return-from-browser">
        
        
          Return from Browser <a href="#return-from-browser" class="header-anchor"></a>
        
        
      </h3>

<p>If the external flow ended with <code class="language-html highlighter-rouge">paymentUrl</code> opened in the browser, we need a way to get back to the app. On Android, this is simple to accomplish by redirecting to an <a href="https://developer.chrome.com/multidevice/android/intents">Android Intent Uri</a>; the SDK and backend work together to construct the Intent Uri to point to the correct app. This Intent will cause the app to be brought back into focus, and the PaymentFragment will recognize the <code class="language-html highlighter-rouge">paymentUrl</code> and reload the payment menu.</p>

<p>On iOS, the situation is more complicated. As mentioned above, <code class="language-html highlighter-rouge">paymentUrl</code> is a Universal Link, and navigation to it should be routed to the app. However, Universal Links are a bit unreliable, in that they require certain conditions to be fulfilled; otherwise, they are opened in the browser like regular links. Unfortunately, one of the conditions, namely that the navigation originated from the user pressing on a link, is often not fulfilled in the external pages used by payment methods. Therefore, we must have a system that works correctly, even if <code class="language-html highlighter-rouge">paymentUrl</code> is opened in the browser.</p>

<p>On iOS, we use the following system:</p>

<ul>
  <li><code class="language-html highlighter-rouge">paymentUrl</code> redirects (301) to a trampoline page hosted at a different domain</li>
  <li>the trampoline page has a button</li>
  <li>pressing that button navigates to <code class="language-html highlighter-rouge">paymentUrl</code> but with an extra parameter</li>
  <li><code class="language-html highlighter-rouge">paymentUrl</code> with the extra parameter redirects to a custom-scheme url</li>
</ul>

<p>The trampoline page is on a different domain due to another requirement of Universal Links: they are only routed to the app if opened from a different domain. Now, both <code class="language-html highlighter-rouge">paymentUrl</code> and <code class="language-html highlighter-rouge">paymentUrl</code> with the extra parameter are Universal Links, and as the second navigation is “forced” to originate from User Interaction, it should be routed to the app. However, if something still goes sideways, and experience says it can, and even this “augmented” <code class="language-html highlighter-rouge">paymentUrl</code> is opened in the browser, then we finally redirect to a custom-scheme url, which has no choice but to be routed to the app. The reason we do not do this immediately is because using custom schemes triggers a confirmation dialog the developer has no control over, and we want to avoid that.</p>

<p>When the app is then launched with <code class="language-html highlighter-rouge">paymentUrl</code>, the augmented <code class="language-html highlighter-rouge">paymentUrl</code>, or the custom-scheme url constructed from <code class="language-html highlighter-rouge">paymentUrl</code>, the Application Delegate must then forward the url to the SDK using the SwedbankPaySDK.open(url:) or SwedbankPaySDK.continue(userActivity:) method, as the case may be. The SDK will then proceed to reload the payment menu as appropriate.</p>

<p>This system does have the drawback of requiring a custom url scheme, which will almost always be left unused. As we gather more data, we may be able to remove the requirement in the future.</p>

<p>Please see this diagram for an illustration of the different steps in the process:</p>

<pre><code class="language-mermaid">sequenceDiagram
    participant User
    participant Browser
    participant Merchant
    participant Trampoline as Universal Link Trampoline
    participant System
    participant SDK
    participant App

    alt Android
        Browser -&gt;&gt; Merchant: Load paymentUrl
        Merchant --&gt;&gt; Browser: 301 Moved Permanently ⑤
        Browser -&gt;&gt; Browser: Parse Android Intent URL
        Browser -&gt;&gt; System: Start activity with the parsed Intent, where the Intent Uri is paymentUrl
        System -&gt;&gt; SDK: Start callback activity
        SDK -&gt;&gt; SDK: Recognize paymentUrl
    else iOS
        alt Happiest Path
            Browser -&gt;&gt; Browser: Recognize that paymentUrl is a Universal Link for App
            Browser -&gt;&gt; System: Launch app with paymentUrl ⑥
        else Less Happy Path
            Browser -&gt;&gt; Merchant: Load paymentUrl
            Merchant --&gt;&gt; Browser: 301 Moved Permanently ⑦
            Browser -&gt;&gt; Trampoline: Load trampoline page
            Browser -&gt;&gt; User: Show trampoline page ⑧
            User -&gt;&gt; Browser: Press "Return to App" button
            Browser -&gt;&gt; Browser: Navigate to paymentUrl&amp;fallback=true
            alt Less Happy Path (contd.)
                Browser -&gt;&gt; Browser : Recognize that paymentUrl&amp;fallback=true is a Universal Link for App
                Browser -&gt;&gt; System : Launch app with paymentUrl&amp;fallback=true
            else Sad Path ⑨
                Browser -&gt;&gt; Merchant: Load paymentUrl&amp;fallback=true
                Merchant --&gt;&gt; Browser: 301 Moved Permanently ⑩
                Browser -&gt;&gt; User: Show confirmation dialog
                User -&gt;&gt; Browser: Accept app launch
                Browser -&gt;&gt; System: Launch app with customscheme://[paymentUrl-without-scheme]&amp;fallback=true
            end
        end
        System -&gt;&gt; App: Call URL handler ⑪
        App -&gt;&gt; SDK: SwedbankPaySDK.open(url:) or SwedbankPaySDK.continue(userActivity:)
        SDK -&gt;&gt; SDK: Recognize paymentUrl or modified paymentUrl
    end
</code></pre>

<ul>
  <li>⑤ Location: <code class="language-html highlighter-rouge">intent://[paymentUrl-without-scheme]/#Intent;scheme=[paymentUrl-scheme];action=com.swedbankpay.mobilesdk.VIEW_PAYMENTORDER;package=[app-package];end;</code></li>
  <li>⑥ Universal Links have certain conditions for them to be activated. One of these is that the navigation must have started from a user interaction. As many 3D-Secure pages have an automatic redirect, this can cause the link to be opened in the Browser instead. Therefore the chance for this path to be taken is low. (N.B. It does seem than iOS 13.4 has made some change to the logic, causing this happiest path to be hit more often.)</li>
  <li>⑦ Location: <code class="language-html highlighter-rouge">https://trampoline.page.host/trampoline/page/path?target=paymentUrl%26fallback=true</code></li>
  <li>⑧  The “Trampoline Page” has a button, which links back to paymentUrl, but with an additional query parameter (actually this extra parameter is added by the backend when generating the redirect to the trampoline page). Importantly, the Trampoline is on a different domain than paymentUrl, as Universal Links are only forwarded to the app if they are opened from a different domain than the link’s domain.</li>
  <li>⑨ All cases should be caught by one of these two flows. However, Universal Links remain finicky, and therefore it is good to provide one final fallback.</li>
  <li>⑩ Location: <code class="language-html highlighter-rouge">customscheme://[paymentUrl-without-scheme]<span class="err">&amp;</span>fallback=true</code>. <code class="language-html highlighter-rouge">customscheme</code> is a URL scheme unique to the App.</li>
  <li>⑪ Universal links result in a call to <code class="language-html highlighter-rouge">UIApplicationDelegate.application(_:continue:restorationHandler:)</code>, while custom-scheme links result in a call to <code class="language-html highlighter-rouge">UIApplicationDelegate.application(_:open:options:)</code>.</li>
</ul>
    
      <h2 id="payment-completion">
        
        
          Payment Completion <a href="#payment-completion" class="header-anchor"></a>
        
        
      </h2>

<p>When the payment is completed, possibly after reloading the payment menu after a navigation to <code class="language-html highlighter-rouge">paymentUrl</code>, the payment menu will report success by attempting to navigate to <code class="language-html highlighter-rouge">completeUrl</code>. The SDK intercepts this and invokes a callback to your app. It is your app’s responsibility to then remove the payment UI from view and notify the user. Similarly, if the payment is canceled, the SDK intercepts the navigation to <code class="language-html highlighter-rouge">cancelUrl</code> and reports the cancellation status to your app.</p>

<pre><code class="language-mermaid">sequenceDiagram
    participant User
    participant App
    participant SDK
    participant WebView

    SDK -&gt;&gt; WebView: Reload &lt;html&gt;...&lt;script src="[paymentorder-script]"&gt;...payex.hostedView.paymentMenu(...)...&lt;/html&gt;
    WebView -&gt;&gt; SDK: Navigate to completeUrl
    SDK -&gt;&gt; WebView: Cancel navigation
    alt Android
        SDK -&gt;&gt; SDK: PaymentViewModel.state &lt;- SUCCESS
        SDK -&gt;&gt; App: Observer&lt;PaymentViewModel.State&gt;.onChanged(SUCCESS)
    else iOS
        SDK -&gt;&gt; App: SwedbankPaySDKDelegate.paymentComplete()
    end
    App -&gt;&gt; App: Remove payment UI component
    App -&gt;&gt; User: Report payment result
</code></pre>

<nav class="iterator d-flex">
    
        <a class="mr-auto btn btn-guiding" role="button" rel="prev" href="ios">
            Back: iOS
        </a>
    

    
        <a class="ml-auto btn btn-executive" role="button" rel="next" href="plain-webview">
            Next: Using a Web View Instead
        </a>
    
</nav>
                                    
                                </div>

                                <div class="col-2 d-none d-lg-block">
                                    <nav class="doc-toc">
                                        <ul>
  <li class="toc-2"><a href="#initialization">Initialization</a></li>
  <li class="toc-2"><a href="#discover-endpoints">Discover Endpoints</a></li>
  <li class="toc-2"><a href="#optional-checkin">Optional Checkin</a></li>
  <li class="toc-2"><a href="#begin-checkout">Begin Checkout</a></li>
  <li class="toc-2"><a href="#external-content">External Content</a></li>
  <li class="toc-2"><a href="#payment-completion">Payment Completion</a></li>
</ul>
                                    </nav>
                                </div>
                            </div>
                        </div>
                    </main>
                </div>
            </div>

            <footer class="page-footer">
                <p class="page-footer-rights">© Swedbank Pay</p>
            </footer>
        </div>

        <script src="https://design.swedbankpay.com/v/4.6.1/scripts/dg.js"></script>
        <script src="/assets/js/swedbank-pay-design-guide-theme.js"></script>
            <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-156582708-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-156582708-1');
</script>

    </body>
</html>
